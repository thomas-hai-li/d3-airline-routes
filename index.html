<!-- Coursera NYU - Information Visualization: Programming with D3.js -->
<!DOCTYPE html>
<html class="gr__d3c33hcgiwev3_cloudfront_net">
<head>
    <title>Visualize Airline Routes</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">

    <style>
        body {
            font-family: Helvetica, Arial, sans-serif
        }

        h1 {
            background-color: #2a5599;
            color: white;
            padding: 5px;
        }

        svg {
            border: 1px solid black;
        }

        .mainView {
            display: flex;
        }
    </style>

    <script src="d3.js"></script>
</head>

<body data-gr-c-s-loaded="true">
    <h1>Airlines Routes</h1>
    <div class="mainView">
        <div>
            <h2>Airlines</h2>
            <svg id="AirlinesChart"></svg>
        </div>
        <div>
            <h2>Airports</h2>
            <svg id="Map"></svg>
        </div>
    </div>
</body>

<script>
    function loadData() {
        return Promise.all([
            d3.csv("routes.csv"),
            d3.json("countries.geo.json"),
        ]).then(datasets => {
            store.routes = datasets[0];
            store.geoJSON = datasets[1];
            return store;
        })
    }

    function showData() {
        let routes = store.routes;
        // Compute the number of routes per airline.
        let airlines = groupByAirline(routes);
        console.log(airlines);
        // Draw airlines barchart and draw base map
        drawAirlinesChart(airlines);
        drawMap(store.geoJSON);
    }

    function groupByAirline(data) {
        //Iterate over each route, producing a dictionary where the keys are the airlines IDs and the values are the properties of the airline
        let result = data.reduce((result, d) => {
            let currentData = result[d.AirlineID] || {
                "AirlineID": d.AirlineID,
                "AirlineName": d.AirlineName,
                "Count": 0
            }

            currentData.Count += 1;
            result[d.AirlineID] = currentData;

            return result;
        }, {});

        //Convert result into a list
        result = Object.keys(result).map(key => result[key])
        result.sort(function (d1, d2) {
            return d3.descending(d1.Count, d2.Count);            
        });

        return result;
    }

    function drawAirlinesChart(airlines) {
        let config = getAirlinesChartConfig();
        let scales = getAirlinesChartScales(airlines, config);
        drawBarsAirlinesChart(airlines, scales, config);
        drawAxesAirlinesChart(airlines, scales, config);
    }

    function getAirlinesChartConfig() {
        // Sets barchart SVG dimensions and returns an object with the dim of the actual barchart
        let width = 350;
        let height = 400;
        let margin = {
            top: 10,
            bottom: 50,
            left: 130,
            right: 10
        }
        //The body is the area that will be occupied by the bars.
        let bodyHeight = height - margin.top - margin.bottom;
        let bodyWidth = width - margin.right - margin.left;

        //Container is the barchart SVG
        let container = d3.select("#AirlinesChart");
        container.attr("width", width);
        container.attr("height", height);

        return { width, height, margin, bodyHeight, bodyWidth, container }
    }

    function getAirlinesChartScales(airlines, config) {
            let { bodyWidth, bodyHeight } = config;
            let maximumCount = d3.max(airlines, d => d.Count);

            let xScale = d3.scaleLinear()
                .domain([0, maximumCount])
                .range([0, bodyWidth])

            let yScale = d3.scaleBand()
                .domain(airlines.map(a => a.AirlineName)) //The domain is the list of airlines names
                .range([0, bodyHeight])
                .padding(0.2)

            return { xScale, yScale }
    }

    function drawBarsAirlinesChart(airlines, scales, config) {
        let { margin, container } = config;
        let { xScale, yScale } = scales;

        let body = container.append("g")
            .style("transform",
                `translate(${margin.left}px,${margin.top}px)`)

        let bars = body.selectAll(".bar").data(airlines)

        //Draw a rect tag for each airline
        bars.enter().append("rect")
            .attr("height", yScale.bandwidth())
            .attr("y", (d) => yScale(d.AirlineName))
            .attr("width", (d) => xScale(d.Count))
            .attr("fill", "#2a5599")
    }

    function drawAxesAirlinesChart(airlines, scales, config) {
        let { xScale, yScale } = scales;
        let { container, margin, height } = config;
        let axisX = d3.axisBottom(xScale)
            .ticks(5)

        container.append("g")
            .style("transform",
                `translate(${margin.left}px,${height - margin.bottom}px)`
            )
            .call(axisX)

        let axisY = d3.axisLeft(yScale);

        container.append("g")
            .style("transform",
                `translate(${margin.left}px,${margin.top}px)`
            )
            .call(axisY)
    }

    function getMapConfig(){
        // Set and return information of the size of the map
        let width = 600;
        let height = 400;
        let container = d3.select("#Map")

        container.attr("width", width);
        container.attr("height", height);

        return {width, height, container}
    }

    function getMapProjection(config) {
        // Create and return projection
        let { width, height } = config;

        let projection = d3.geoMercator();
        projection.scale(97)
            .translate([width / 2, height / 2 + 20])

        store.mapProjection = projection;   // Save in store for easy access
        return projection;
    }

    function drawBaseMap(container, countries, projection) {
        // Draw base map by using path generator
        let path = d3.geoPath()
            .projection(projection)

        container.selectAll("path").data(countries)
            .enter().append("path")
            .attr("d", path)
            .attr("stroke", "#ccc")
            .attr("fill", "#eee")
    }

    function drawMap(geoJson) {
        let config = getMapConfig();
        let projection = getMapProjection(config)
        drawBaseMap(config.container, geoJson.features, projection)
    }

    let store = {};
    loadData().then(showData);
</script>
</html>
